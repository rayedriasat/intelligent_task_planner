{% extends 'base.html' %}
{% load static %}

{% block title %}Calendar - KajBuzz{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Ensure CSRF token is available for JavaScript -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">



<div class="h-full flex flex-col p-6" x-data="calendarApp()" x-init="init()">
    

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Calendar</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
                {{ week_start|date:"F j" }} - {{ week_end|date:"F j, Y" }}
            </p>
        </div>
        
        <div class="flex items-center space-x-4">
            <!-- Week Navigation -->
            <div class="flex items-center space-x-2">
                <a href="?week={{ prev_week|date:'Y-m-d' }}" 
                   class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                
                <a href="?" 
                   class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    Today
                </a>
                
                <a href="?week={{ next_week|date:'Y-m-d' }}" 
                   class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </a>
            </div>
            
            <!-- Re-optimize Button -->
            <button @click="reoptimizeSchedule()" 
                    :disabled="isOptimizing"
                    class="bg-primary hover:bg-blue-600 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" :class="{ 'animate-spin': isOptimizing }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span x-text="isOptimizing ? 'Optimizing...' : 'Re-optimize'"></span>
            </button>
            
            <!-- Get AI Suggestion Button -->
            <button @click="getAISuggestions()" 
                    :disabled="aiLoading"
                    class="bg-purple-600 hover:bg-purple-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" :class="{ 'animate-spin': aiLoading }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <span x-text="aiLoading ? 'Getting AI Suggestions...' : 'Get AI Suggestion'"></span>
            </button>
            
            <!-- Export PDF Button -->
            <a href="{% url 'planner:schedule_pdf_form' %}" 
               class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span>Export PDF</span>
            </a>
            
            <!-- Google Calendar Integration -->
            {% if has_google_calendar %}
            <div class="flex items-center space-x-2">
                <!-- Sync Status Indicator -->
                <div class="flex items-center">
                    {% if google_integration.is_enabled %}
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Synced</span>
                    {% else %}
                        <div class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Sync Off</span>
                    {% endif %}
                </div>
                
                <!-- Quick Sync Button -->
                <button @click="quickSync()" 
                        :disabled="isSyncing"
                        class="bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-1">
                    <svg class="w-4 h-4" :class="{ 'animate-spin': isSyncing }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span x-text="isSyncing ? 'Syncing...' : 'Sync'"></span>
                </button>
                
                <!-- Calendar Settings Button -->
                <a href="{% url 'planner:google_calendar_settings' %}" 
                   class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </a>
            </div>
            {% else %}
            <!-- Setup Google Calendar Button -->
            <a href="{% url 'planner:google_calendar_settings' %}" 
               class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Setup Google Calendar</span>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Calendar Container -->
    <div class="flex-1 flex gap-6">
        <!-- Main Calendar Grid -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <!-- Calendar Header - Day Names -->
            <div class="calendar-header">
                <!-- Empty corner for time column -->
                <div class="time-column-header"></div>
                <!-- Day headers -->
                {% for day in week_days %}
                <div class="day-header {% if day.is_today %}today{% endif %}">
                    <div class="day-name">{{ day.day_short }}</div>
                    <div class="day-number">{{ day.day_num }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Calendar Body with Time Grid -->
            <div class="calendar-body">
                <!-- Time Column -->
                <div class="time-column">
                    {% for hour_data in hours %}
                    <div class="time-slot" data-hour="{{ hour_data.hour }}">
                        <span class="time-label">{{ hour_data.label }}</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Days Grid -->
                <div class="days-grid">
                    {% for day in week_days %}
                    <div class="day-column" data-date="{{ day.date|date:'Y-m-d' }}">
                        <!-- Hour slots for this day -->
                        {% for hour_data in hours %}
                        <div class="hour-slot" 
                             data-hour="{{ hour_data.hour }}"
                             data-date="{{ day.date|date:'Y-m-d' }}"
                             @dragover.prevent="handleDragOver($event)"
                             @drop="handleDrop($event, '{{ day.date|date:'Y-m-d' }}', {{ hour_data.hour }})"
                             @click="openSchedulingModal('{{ day.date|date:'Y-m-d' }}', {{ hour_data.hour }})"
                             class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                             style="position: relative; z-index: 1;">
                             <!-- Visual indicator for clickable area -->
                             <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-20 transition-opacity">
                                 <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                 </svg>
                             </div>
                        </div>
                        {% endfor %}

                        <!-- Render tasks for this day -->
                        {% for task in day.tasks %}
                        <div class="task-block"
                             draggable="true"
                             data-task-id="{{ task.id }}"
                             @dragstart="handleTaskDragStart($event, {{ task.id }})"
                             style="
                                top: {{ task.position_top|floatformat:1 }}rem;
                                height: {{ task.position_height|floatformat:1 }}rem;
                             ">
                            <div class="task-content">
                                <div class="task-title">{{ task.title }}</div>
                                <div class="task-time">{{ task.start_time|date:"g:i A" }}</div>
                                {% if task.is_locked %}
                                <div class="task-lock">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                {% endif %}
                                <button class="task-remove" @click.stop="unscheduleTask({{ task.id }})">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Current Time Indicator (only for today) -->
                        {% if day.is_today %}
                        <div x-show="shouldShowCurrentTimeIndicator()" 
                             x-ref="timeIndicator"
                             class="current-time-indicator-day"
                             :style="'top: ' + getCurrentTimePosition() + 'rem;'">
                            <div class="current-time-line"></div>
                            <div class="current-time-dot"></div>
                            <div class="current-time-label" x-text="getCurrentTimeLabel()"></div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Enhanced Unscheduled Tasks Sidebar -->
        <div class="w-96 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col">
            <!-- Header with filters -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Unscheduled Tasks</h3>
                    <button @click="refreshUnscheduled()" 
                            class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
                
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">
                        <span x-text="filteredTasks.length">{{ unscheduled_tasks.count }}</span> tasks need scheduling
                    </span>
                    <div class="flex items-center space-x-2">
                        <button @click="showFilters = !showFilters" 
                                class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Filters
                        </button>
                        <button @click="showAnalysis = !showAnalysis" 
                                class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                            Analysis
                        </button>
                    </div>
                </div>
                
                <!-- Filters Panel -->
                <div x-show="showFilters" x-collapse class="mt-3 space-y-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                        <select x-model="priorityFilter" @change="applyFilters()" 
                                class="w-full text-xs border rounded px-2 py-1 dark:bg-gray-700 dark:border-gray-600">
                            <option value="all">All Priorities</option>
                            <option value="1">High Priority</option>
                            <option value="2">Medium Priority</option>
                            <option value="3">Low Priority</option>
                            <option value="4">Lowest Priority</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Sort by</label>
                        <select x-model="sortBy" @change="applyFilters()" 
                                class="w-full text-xs border rounded px-2 py-1 dark:bg-gray-700 dark:border-gray-600">
                            <option value="deadline">Deadline</option>
                            <option value="priority">Priority</option>
                            <option value="estimated_hours">Duration</option>
                            <option value="created_at">Date Created</option>
                        </select>
                    </div>
                </div>
                
                <!-- Analysis Panel -->
                <div x-show="showAnalysis" x-collapse class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <div class="text-xs space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Total Hours:</span>
                            <span class="font-medium" x-text="totalUnscheduledHours + 'h'">0h</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Avg Task Size:</span>
                            <span class="font-medium" x-text="avgTaskSize + 'h'">0h</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Urgent Tasks:</span>
                            <span class="font-medium text-red-600" x-text="urgentTasksCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks List -->
            <div class="flex-1 p-4 space-y-3 overflow-y-auto">
                <template x-for="task in filteredTasks" :key="task.id">
                    <div class="unscheduled-task-enhanced"
                         draggable="true"
                         :data-task-id="task.id"
                         :class="{
                             'border-red-300 bg-red-50 dark:bg-red-900/20': task.is_urgent,
                             'border-yellow-300 bg-yellow-50 dark:bg-yellow-900/20': task.priority <= 2 && !task.is_urgent,
                             'border-gray-300 bg-gray-50 dark:bg-gray-700': task.priority > 2 && !task.is_urgent
                         }"
                         @dragstart="handleTaskDragStart($event, task.id)">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="font-medium text-gray-900 dark:text-white text-sm" x-text="task.title"></h4>
                                    <span x-show="task.is_urgent" class="text-xs bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-1 rounded">URGENT</span>
                                </div>
                                <div class="flex items-center space-x-3 text-xs text-gray-500 dark:text-gray-400">
                                    <span x-text="task.estimated_hours + 'h'"></span>
                                    <span x-text="'Due: ' + formatDate(task.deadline)"></span>
                                    <span x-text="'P' + task.priority" :class="{
                                        'text-green-600': task.priority === 1,
                                        'text-yellow-600': task.priority === 2,
                                        'text-orange-600': task.priority === 3,
                                        'text-red-600': task.priority === 4
                                    }"></span>
                                </div>
                                <div x-show="task.description" class="mt-1 text-xs text-gray-600 dark:text-gray-400 line-clamp-2" x-text="task.description"></div>
                            </div>
                            <div class="flex flex-col items-end space-y-1">
                                <div class="priority-indicator" :class="'priority-' + task.priority"></div>
                                <button @click="quickScheduleTask(task.id)" 
                                        class="text-xs text-blue-600 dark:text-blue-400 hover:underline">
                                    Quick Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                
                <div x-show="filteredTasks.length === 0" class="text-center py-8 text-gray-400 dark:text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-sm" x-text="unscheduledTasks.length === 0 ? 'All tasks scheduled!' : 'No tasks match filters'"></p>
                </div>
            </div>
            
            <!-- Quick Actions Footer -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex space-x-2">
                    <button @click="scheduleAllUrgent()" 
                            class="flex-1 text-xs bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded transition-colors">
                        Schedule Due Soon
                    </button>
                    <button @click="scheduleByPriority()" 
                            class="flex-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded transition-colors">
                        Auto Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Manual Scheduling Modal -->
    <div x-show="showSchedulingModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="closeSchedulingModal()">
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4"
             @click.stop>
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        Schedule Task
                    </h3>
                    <button @click="closeSchedulingModal()" 
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        <span x-text="formatSchedulingDateTime()"></span>
                    </p>
                </div>
                
                <!-- Tab Selection -->
                <div class="mb-4">
                    <div class="flex space-x-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                        <button @click="schedulingTab = 'existing'" 
                                :class="schedulingTab === 'existing' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-gray-400'"
                                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors">
                            Schedule Existing
                        </button>
                        <button @click="schedulingTab = 'new'" 
                                :class="schedulingTab === 'new' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-gray-400'"
                                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors">
                            Create New
                        </button>
                    </div>
                </div>
                
                <!-- Schedule Existing Task -->
                <div x-show="schedulingTab === 'existing'" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Select Task
                        </label>
                        <select x-model="selectedTaskId" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">Choose a task...</option>
                            <template x-for="task in unscheduledTasks" :key="task.id">
                                <option :value="task.id" x-text="`${task.title} (${task.estimated_hours}h)`"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Time
                        </label>
                        <input type="time" x-model="selectedTime" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button @click="closeSchedulingModal()" 
                                class="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                        <button @click="scheduleExistingTask()" 
                                :disabled="!selectedTaskId || isScheduling"
                                :class="selectedTaskId && !isScheduling ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'"
                                class="flex-1 px-4 py-2 text-white rounded-md transition-colors disabled:cursor-not-allowed">
                            <span x-show="!isScheduling">Schedule Task</span>
                            <span x-show="isScheduling">Scheduling...</span>
                        </button>
                    </div>
                </div>
                
                <!-- Create New Task -->
                <div x-show="schedulingTab === 'new'" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Task Title
                        </label>
                        <input type="text" x-model="newTaskTitle" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                               placeholder="Enter task title...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Description (Optional)
                        </label>
                        <textarea x-model="newTaskDescription" 
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                                  rows="2" placeholder="Enter description..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Time
                        </label>
                        <input type="time" x-model="selectedTime" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Hours
                            </label>
                            <input type="number" x-model="newTaskHours" step="0.5" min="0.5" max="8"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Priority
                            </label>
                            <select x-model="newTaskPriority"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                <option value="1">High</option>
                                <option value="2">Medium</option>
                                <option value="3">Low</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button @click="closeSchedulingModal()" 
                                class="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                        <button @click="createAndScheduleTask()" 
                                :disabled="!newTaskTitle.trim() || isScheduling"
                                :class="newTaskTitle.trim() && !isScheduling ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'"
                                class="flex-1 px-4 py-2 text-white rounded-md transition-colors disabled:cursor-not-allowed">
                            <span x-show="!isScheduling">Create & Schedule</span>
                            <span x-show="isScheduling">Creating...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sacrifice Mode Modal -->
    <div x-show="sacrificeMode" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Sacrifice Mode</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                No available time slots. Choose which tasks to reschedule to make room for your urgent task.
                            </p>
                        </div>
                        <button @click="cancelSacrificeMode()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Urgent Task Info -->
                    <div x-show="urgentTask" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-red-800 dark:text-red-200 mb-1">Urgent Task</h4>
                        <p class="text-red-700 dark:text-red-300" x-text="urgentTask?.title"></p>
                        <p class="text-sm text-red-600 dark:text-red-400 mt-1">
                            Duration: <span x-text="urgentTask?.estimated_hours + ' hours'"></span>
                        </p>
                    </div>
                    
                    <!-- Target Time Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Schedule urgent task at:
                        </label>
                        <input type="datetime-local" 
                               x-model="targetDateTime"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <!-- Conflicting Tasks -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Tasks to Reschedule</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            Select tasks to move back to the unscheduled tasks tray:
                        </p>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            <template x-for="task in conflictingTasks" :key="task.id">
                                <div class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <input type="checkbox" 
                                           :id="'sacrifice-' + task.id"
                                           :value="task.id"
                                           x-model="selectedSacrifices"
                                           class="mr-3">
                                    <label :for="'sacrifice-' + task.id" class="flex-1 cursor-pointer">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h5 class="font-medium text-gray-900 dark:text-white" x-text="task.title"></h5>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                                    <span x-text="formatDateTime(task.start_time)"></span> - 
                                                    <span x-text="formatDateTime(task.end_time)"></span>
                                                    (<span x-text="task.estimated_hours + 'h'"></span>)
                                                </p>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs px-2 py-1 rounded" 
                                                      :class="{
                                                          'bg-green-100 text-green-800': task.priority === 1,
                                                          'bg-yellow-100 text-yellow-800': task.priority === 2,
                                                          'bg-orange-100 text-orange-800': task.priority === 3,
                                                          'bg-red-100 text-red-800': task.priority === 4
                                                      }"
                                                      x-text="'P' + task.priority">
                                                </span>
                                                <span x-show="task.is_locked" class="text-yellow-600">
                                                    ðŸ”’
                                                </span>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex justify-end space-x-3">
                        <button @click="cancelSacrificeMode()"
                                class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                        <button @click="executeSacrifice()"
                                :disabled="!targetDateTime"
                                class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors">
                            Schedule Urgent Task
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overload Resolution Modal -->
    <div x-show="showOverloadModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center space-x-2">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                                <span>Schedule Overload Detected</span>
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                You have more tasks than available time. Choose a resolution strategy.
                            </p>
                        </div>
                        <button @click="closeOverloadModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Overload Summary -->
                    <div x-show="overloadInfo" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-red-700 dark:text-red-300">Required Time:</span>
                                <span class="font-medium text-red-800 dark:text-red-200" x-text="overloadInfo?.total_required_hours + ' hours'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-red-700 dark:text-red-300">Available Time:</span>
                                <span class="font-medium text-red-800 dark:text-red-200" x-text="overloadInfo?.total_available_hours + ' hours'"></span>
                            </div>
                            <div class="flex justify-between border-t border-red-200 dark:border-red-800 pt-2">
                                <span class="text-red-700 dark:text-red-300 font-medium">Excess:</span>
                                <span class="font-bold text-red-800 dark:text-red-200" x-text="overloadInfo?.excess_hours + ' hours (' + overloadInfo?.overload_percentage + '% over capacity)'"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resolution Options -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-900 dark:text-white">Choose Resolution Strategy:</h4>
                        
                        <!-- Compress Schedule Option -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                             @click="selectedResolution = 'compress'">
                            <div class="flex items-start space-x-3">
                                <input type="radio" x-model="selectedResolution" value="compress" class="mt-1">
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900 dark:text-white">Compress Schedule</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                        Reduce all task durations proportionally to fit within available time. 
                                        <span x-show="overloadInfo" class="font-medium">
                                            Each task will be compressed to <span x-text="Math.round((1 / overloadInfo?.overload_ratio) * 100) + '%'"></span> of original duration.
                                        </span>
                                    </p>
                                    <div class="mt-2 text-xs text-blue-600 dark:text-blue-400">
                                        âœ“ Keeps all tasks scheduled âœ“ Proportional reduction âœ“ Quick solution
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prioritize & Schedule Option -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                             @click="selectedResolution = 'prioritize'">
                            <div class="flex items-start space-x-3">
                                <input type="radio" x-model="selectedResolution" value="prioritize" class="mt-1">
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900 dark:text-white">Prioritize & Schedule</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                        Schedule high-priority and deadline-critical tasks first. Tasks with distant deadlines will remain unscheduled.
                                    </p>
                                    <div class="mt-2 text-xs text-green-600 dark:text-green-400">
                                        âœ“ Preserves task durations âœ“ Deadline-aware âœ“ Priority-based selection
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <button @click="closeOverloadModal()"
                                class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                        <button @click="executeOverloadResolution()"
                                :disabled="!selectedResolution || isResolvingOverload"
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors">
                            <span x-show="!isResolvingOverload">Apply Resolution</span>
                            <span x-show="isResolvingOverload">Processing...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Suggestions Modal -->
    <div x-show="showAISuggestions" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                <span>AI Scheduling Suggestions</span>
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                AI-powered suggestions to optimize your schedule
                            </p>
                        </div>
                        <button @click="closeAISuggestions()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Loading State -->
                    <div x-show="aiLoading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                        <p class="mt-4 text-gray-600 dark:text-gray-400">Getting AI suggestions...</p>
                    </div>
                    
                    <!-- Error State -->
                    <div x-show="aiError && !aiLoading" class="text-center py-8">
                        <div class="text-red-500 mb-4">
                            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Unable to get AI suggestions</h4>
                        <p class="text-gray-600 dark:text-gray-400" x-text="aiError"></p>
                        <button @click="getAISuggestions()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                            Try Again
                        </button>
                    </div>
                    
                    <!-- Success State - AI Suggestions -->
                    <div x-show="aiSuggestions && aiSuggestions.length > 0 && !aiLoading" class="space-y-6">
                        <!-- Overall Score and Reasoning -->
                        <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-semibold text-purple-800 dark:text-purple-200">AI Analysis</h4>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-purple-600 dark:text-purple-400">Confidence Score:</span>
                                    <span class="font-bold text-purple-800 dark:text-purple-200" x-text="Math.round(aiOverallScore * 100) + '%'"></span>
                                </div>
                            </div>
                            <p class="text-purple-700 dark:text-purple-300" x-text="aiReasoning"></p>
                        </div>
                        
                        <!-- Suggestions List -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white">Suggested Schedule Changes</h4>
                            <div class="grid gap-4 max-h-96 overflow-y-auto">
                                <template x-for="suggestion in aiSuggestions" :key="suggestion.task_id">
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <h5 class="font-medium text-gray-900 dark:text-white" x-text="suggestion.task_title"></h5>
                                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" x-text="suggestion.task_description"></p>
                                                
                                                <div class="mt-3 space-y-2">
                                                    <div class="flex items-center space-x-4 text-sm">
                                                        <span class="text-gray-500">Suggested Time:</span>
                                                        <span class="font-medium text-gray-900 dark:text-white" x-text="formatDateTime(suggestion.suggested_start_time) + ' - ' + formatDateTime(suggestion.suggested_end_time)"></span>
                                                    </div>
                                                    <div class="flex items-center space-x-4 text-sm">
                                                        <span class="text-gray-500">Confidence:</span>
                                                        <div class="flex items-center space-x-2">
                                                            <div class="w-16 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                                                <div class="bg-purple-600 h-2 rounded-full" :style="`width: ${suggestion.confidence_score * 100}%`"></div>
                                                            </div>
                                                            <span class="font-medium" x-text="Math.round(suggestion.confidence_score * 100) + '%'"></span>
                                                        </div>
                                                    </div>
                                                    <div class="text-sm text-gray-600 dark:text-gray-400">
                                                        <span class="font-medium">Reasoning:</span> <span x-text="suggestion.reasoning"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="flex items-center space-x-2 ml-4">
                                                <input type="checkbox" 
                                                       :id="'suggestion-' + suggestion.task_id"
                                                       :value="suggestion.task_id + '_' + suggestion.suggested_start_time"
                                                       x-model="selectedSuggestions"
                                                       class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                                <label :for="'suggestion-' + suggestion.task_id" class="text-sm text-gray-600 dark:text-gray-400">Accept</label>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No Suggestions State -->
                    <div x-show="aiSuggestions && aiSuggestions.length === 0 && !aiLoading && !aiError" class="text-center py-8">
                        <div class="text-gray-400 mb-4">
                            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">All caught up!</h4>
                        <p class="text-gray-600 dark:text-gray-400">No unscheduled tasks found, or your current schedule is already optimal.</p>
                    </div>
                    
                    <!-- Actions -->
                    <div x-show="aiSuggestions && aiSuggestions.length > 0 && !aiLoading" class="flex justify-between items-center mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            <span x-text="selectedSuggestions.length"></span> of <span x-text="aiSuggestions.length"></span> suggestions selected
                        </div>
                        <div class="flex space-x-3">
                            <button @click="closeAISuggestions()"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                Dismiss
                            </button>
                            <button @click="applyAISuggestions()"
                                    :disabled="selectedSuggestions.length === 0"
                                    class="px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors">
                                Apply Selected Suggestions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Google Calendar Style CSS */
.calendar-header {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.dark .calendar-header {
    border-bottom-color: #374151;
    background-color: #111827;
}

.time-column-header {
    border-right: 1px solid #e5e7eb;
}

.dark .time-column-header {
    border-right-color: #374151;
}

.day-header {
    padding: 16px 8px;
    text-align: center;
    border-right: 1px solid #e5e7eb;
}

.day-header:last-child {
    border-right: none;
}

.day-header.today {
    background-color: #dbeafe;
}

.dark .day-header {
    border-right-color: #374151;
}

.dark .day-header.today {
    background-color: #1e3a8a;
}

.day-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
}

.dark .day-name {
    color: #9ca3af;
}

.day-number {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
    margin-top: 4px;
}

.day-header.today .day-number {
    color: #2563eb;
}

.dark .day-number {
    color: #f9fafb;
}

.dark .day-header.today .day-number {
    color: #60a5fa;
}

.calendar-body {
    display: grid;
    grid-template-columns: 80px 1fr;
    height: 1155px;
}

.time-column {
    border-right: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.dark .time-column {
    border-right-color: #374151;
    background-color: #111827;
}

.time-slot {
    height: 4rem;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 4px;
    border-bottom: 1px solid #f3f4f6;
    position: relative;
}

.dark .time-slot {
    border-bottom-color: #374151;
}

.time-label {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
}

.dark .time-label {
    color: #9ca3af;
}

.days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    position: relative;
}

.day-column {
    border-right: 1px solid #e5e7eb;
    position: relative;
    min-height: 100%;
}

.day-column:last-child {
    border-right: none;
}

.dark .day-column {
    border-right-color: #374151;
}

.hour-slot {
    height: 4rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.hour-slot:hover {
    background-color: #f3f4f6;
}

.dark .hour-slot {
    border-bottom-color: #374151;
}

.dark .hour-slot:hover {
    background-color: #374151;
}

.task-block {
    position: absolute;
    left: 2px;
    right: 2px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-radius: 6px;
    padding: 6px;
    font-size: 0.75rem;
    cursor: move;
    z-index: 10;
    min-height: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.15s ease;
}

.task-block:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.task-content {
    position: relative;
}

.task-title {
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-time {
    font-size: 0.625rem;
    opacity: 0.9;
}

.task-lock {
    position: absolute;
    top: 2px;
    right: 20px;
    opacity: 0.7;
}

.task-remove {
    position: absolute;
    top: 2px;
    right: 2px;
    opacity: 0;
    transition: opacity 0.15s ease;
    color: white;
}

.task-remove:hover {
    opacity: 1;
}

.task-block:hover .task-remove {
    opacity: 1;
}

.unscheduled-task {
    background-color: #fef3c7;
    border: 1px solid #f59e0b;
    border-left: 4px solid #f59e0b;
    border-radius: 6px;
    padding: 12px;
    cursor: move;
    transition: all 0.15s ease;
}

.unscheduled-task:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.dark .unscheduled-task {
    background-color: #451a03;
    border-color: #92400e;
}

/* Enhanced unscheduled task styles */
.unscheduled-task-enhanced {
    border-radius: 8px;
    padding: 12px;
    cursor: move;
    transition: all 0.15s ease;
    border: 1px solid;
    border-left: 4px solid;
}

.unscheduled-task-enhanced:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.priority-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.priority-1 { background-color: #10b981; }
.priority-2 { background-color: #f59e0b; }
.priority-3 { background-color: #ef4444; }
.priority-4 { background-color: #dc2626; }

/* Drag feedback */
.dragging {
    opacity: 0.5;
    transform: scale(0.95);
}

.drag-over {
    background-color: #dbeafe !important;
}

.dark .drag-over {
    background-color: #1e40af !important;
}

/* Current Time Indicator (Day-specific) */
.current-time-indicator-day {
    position: absolute;
    left: 0;
    right: 0;
    pointer-events: none;
    z-index: 15;
}

.current-time-line {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #ef4444;
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
}

.current-time-dot {
    position: absolute;
    left: -6px;
    top: -5px;
    width: 12px;
    height: 12px;
    background-color: #ef4444;
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
}

.current-time-label {
    position: absolute;
    left: 12px;
    top: -10px;
    background-color: #ef4444;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
}
</style>

<script>
function calendarApp() {
    return {
        isOptimizing: false,
        showFilters: false,
        showAnalysis: false,
        priorityFilter: 'all',
        sortBy: 'deadline',
        unscheduledTasks: [],
        filteredTasks: [],
        totalUnscheduledHours: 0,
        avgTaskSize: 0,
        urgentTasksCount: 0,
        
        // AI Suggestions state
        aiLoading: false,
        showAISuggestions: false,
        aiSuggestions: [],
        aiOverallScore: 0,
        aiReasoning: '',
        aiError: null,
        selectedSuggestions: [],
        
        // Sacrifice mode state
        sacrificeMode: false,
        urgentTask: null,
        conflictingTasks: [],
        selectedSacrifices: [],
        targetDateTime: null,
        
        // Manual scheduling modal state
        showSchedulingModal: false,
        schedulingTab: 'existing',
        selectedDate: null,
        selectedHour: null,
        selectedTime: '',
        selectedTaskId: '',
        newTaskTitle: '',
        newTaskDescription: '',
        newTaskHours: 1.0,
        newTaskPriority: 2,
        isScheduling: false,
        
        // Overload resolution modal state
        showOverloadModal: false,
        overloadInfo: null,
        selectedResolution: '',
        isResolvingOverload: false,
        
        init() {
            this.loadUnscheduledTasks();
            
            // Update current time indicator every minute
            this.updateCurrentTimeIndicator();
            setInterval(() => {
                this.updateCurrentTimeIndicator();
            }, 60000); // Update every minute
        },
        
        getCSRFToken() {
            // Try multiple ways to get CSRF token
            let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!token) {
                token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            }
            if (!token) {
                token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
            }
            return token;
        },
        

        
        loadUnscheduledTasks() {
            // Load unscheduled tasks data from server
            const unscheduledData = [
                {% for task in unscheduled_tasks %}
                {
                    id: {{ task.id }},
                    title: "{{ task.title|escapejs }}",
                    description: "{{ task.description|default_if_none:""|escapejs }}",
                    estimated_hours: {{ task.estimated_hours }},
                    priority: {{ task.priority }},
                    deadline: "{{ task.deadline|date:'Y-m-d' }}",
                    created_at: "{{ task.created_at|date:'Y-m-d' }}",
                    is_urgent: {{ task.is_urgent_for_js|yesno:"true,false" }}
                },
                {% empty %}
                {% endfor %}
            ];
            
            this.unscheduledTasks = unscheduledData;
            this.calculateAnalytics();
            this.applyFilters();
        },
        
        calculateAnalytics() {
            this.totalUnscheduledHours = this.unscheduledTasks.reduce((sum, task) => sum + parseFloat(task.estimated_hours), 0).toFixed(1);
            this.avgTaskSize = this.unscheduledTasks.length > 0 ? (this.totalUnscheduledHours / this.unscheduledTasks.length).toFixed(1) : 0;
            this.urgentTasksCount = this.unscheduledTasks.filter(task => task.is_urgent).length;
        },
        
        applyFilters() {
            let filtered = [...this.unscheduledTasks];
            
            // Apply priority filter
            if (this.priorityFilter !== 'all') {
                filtered = filtered.filter(task => task.priority == this.priorityFilter);
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                switch (this.sortBy) {
                    case 'priority':
                        return a.priority - b.priority;
                    case 'estimated_hours':
                        return parseFloat(b.estimated_hours) - parseFloat(a.estimated_hours);
                    case 'created_at':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'deadline':
                    default:
                        return new Date(a.deadline) - new Date(b.deadline);
                }
            });
            
            this.filteredTasks = filtered;
        },
        
        formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays === -1) return 'Yesterday';
            if (diffDays < 0) return `${Math.abs(diffDays)} days ago`;
            if (diffDays <= 7) return `${diffDays} days`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },
        
        refreshUnscheduled() {
            window.location.reload();
        },
        
        quickScheduleTask(taskId) {
            // Find next available slot and schedule task there
            fetch('{% url "planner:quick_schedule_task" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: `task_id=${taskId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(`Task scheduled for ${data.scheduled_time}!`, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Could not find available time'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        scheduleAllUrgent() {
            const urgentTasks = this.unscheduledTasks.filter(task => task.is_urgent);
            if (urgentTasks.length === 0) {
                this.showToast('No tasks due soon to schedule', 'info');
                return;
            }
            
            if (!confirm(`Schedule ${urgentTasks.length} tasks due soon automatically?`)) return;
            
            fetch('{% url "planner:schedule_urgent_tasks" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(`${data.scheduled_count} tasks due soon scheduled!`, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            });
        },
        
        scheduleByPriority() {
            if (!confirm('Automatically schedule all unscheduled tasks by priority?')) return;
            
            fetch('{% url "planner:auto_schedule_all_tasks" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(data.message, 'success');
                    
                    if (data.recommendations && data.recommendations.length > 0) {
                        setTimeout(() => {
                            const recommendations = data.recommendations.join('\nâ€¢ ');
                            alert(`Recommendations:\nâ€¢ ${recommendations}`);
                        }, 1500);
                    }
                    
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        navigateWeek(direction) {
            console.log('Navigate week called with direction:', direction);
            const params = new URLSearchParams(window.location.search);
            const currentWeek = params.get('week') || new Date().toISOString().split('T')[0];
            console.log('Current week:', currentWeek);
            
            const date = new Date(currentWeek);
            date.setDate(date.getDate() + (direction * 7));
            const newWeek = date.toISOString().split('T')[0];
            console.log('New week:', newWeek);
            
            params.set('week', newWeek);
            const newUrl = window.location.pathname + '?' + params.toString();
            console.log('Navigating to:', newUrl);
            window.location.href = newUrl;
        },
        
        goToToday() {
            const params = new URLSearchParams(window.location.search);
            params.delete('week');
            window.location.search = params.toString();
        },
        
        handleTaskDragStart(event, taskId) {
            event.dataTransfer.setData('text/plain', taskId);
            event.target.classList.add('dragging');
        },
        
        handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        },
        
        handleDrop(event, date, hour) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const taskId = event.dataTransfer.getData('text/plain');
            if (taskId) {
                this.scheduleTask(taskId, date, hour);
            }
            
            // Remove dragging class from all elements
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
        },
        
        scheduleTask(taskId, date, hour) {
            const startTime = new Date(`${date}T${hour.toString().padStart(2, '0')}:00:00`);
            
            fetch('{% url "planner:update_task_schedule" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: `task_id=${taskId}&start_time=${startTime.toISOString()}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast('Task scheduled successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        unscheduleTask(taskId) {
            if (!confirm('Remove this task from the schedule?')) return;
            
            fetch('{% url "planner:unschedule_task" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: `task_id=${taskId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast('Task unscheduled!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            });
        },
        
        // Manual Scheduling Functions
        openSchedulingModal(date, hour) {
            console.log('Opening scheduling modal for:', date, hour); // Debug
            this.selectedDate = date;
            this.selectedHour = hour;
            
            // Set default time based on the hour clicked, or current time if no hour specified
            if (hour !== null && hour !== undefined) {
                this.selectedTime = hour.toString().padStart(2, '0') + ':00';
            } else {
                const now = new Date();
                this.selectedTime = now.getHours().toString().padStart(2, '0') + ':' + 
                                   now.getMinutes().toString().padStart(2, '0');
            }
            
            this.showSchedulingModal = true;
            this.schedulingTab = 'existing';
            this.selectedTaskId = '';
            this.newTaskTitle = '';
            this.newTaskDescription = '';
            this.newTaskHours = 1.0;
            this.newTaskPriority = 2;
        },
        
        closeSchedulingModal() {
            this.showSchedulingModal = false;
            this.selectedDate = null;
            this.selectedHour = null;
            this.isScheduling = false;
        },
        
        formatSchedulingDateTime() {
            if (!this.selectedDate || !this.selectedTime) return '';
            
            const date = new Date(this.selectedDate);
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            const dateStr = date.toLocaleDateString('en-US', options);
            
            // Parse the time (HH:MM format) and format it to 12-hour format
            const [hour24, minute] = this.selectedTime.split(':').map(Number);
            let timeStr;
            
            if (hour24 === 0) {
                timeStr = `12:${minute.toString().padStart(2, '0')} AM`;
            } else if (hour24 < 12) {
                timeStr = `${hour24}:${minute.toString().padStart(2, '0')} AM`;
            } else if (hour24 === 12) {
                timeStr = `12:${minute.toString().padStart(2, '0')} PM`;
            } else {
                timeStr = `${hour24 - 12}:${minute.toString().padStart(2, '0')} PM`;
            }
            
            return `${dateStr} at ${timeStr}`;
        },
        
        scheduleExistingTask() {
            if (!this.selectedTaskId || this.isScheduling) return;
            
            this.isScheduling = true;
            
            fetch('{% url "planner:manual_schedule_task" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    task_id: this.selectedTaskId,
                    date: this.selectedDate,
                    time: this.selectedTime
                })
            })
            .then(response => response.json())
            .then(data => {
                this.isScheduling = false;
                
                if (data.success) {
                    this.showToast(data.message, 'success');
                    this.closeSchedulingModal();
                    // Reload the page to show the scheduled task
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                this.isScheduling = false;
                this.showToast('Network error occurred', 'error');
                console.error('Scheduling error:', error);
            });
        },
        
        createAndScheduleTask() {
            if (!this.newTaskTitle.trim() || this.isScheduling) return;
            
            this.isScheduling = true;
            
            fetch('{% url "planner:create_and_schedule_task" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    title: this.newTaskTitle.trim(),
                    description: this.newTaskDescription.trim(),
                    estimated_hours: this.newTaskHours,
                    priority: this.newTaskPriority,
                    date: this.selectedDate,
                    time: this.selectedTime
                })
            })
            .then(response => response.json())
            .then(data => {
                this.isScheduling = false;
                
                if (data.success) {
                    this.showToast(data.message, 'success');
                    this.closeSchedulingModal();
                    // Reload the page to show the new task
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                this.isScheduling = false;
                this.showToast('Network error occurred', 'error');
                console.error('Create and schedule error:', error);
            });
        },
        
        quickAddTask(date, hour) {
            // Deprecated - now opens the scheduling modal
            this.openSchedulingModal(date, hour);
        },
        
        reoptimizeSchedule() {
            console.log('DEBUG: reoptimizeSchedule() called');
            this.isOptimizing = true;
            
            // First check for overload before proceeding with optimization
            fetch('{% url "planner:check_overload" %}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                this.isOptimizing = false;
                
                if (data.is_overloaded) {
                    // Show overload resolution modal
                    this.openOverloadModal(data.overload_data);
                } else {
                    // Proceed with normal optimization
                    this.proceedWithOptimization();
                }
            })
            .catch(error => {
                this.isOptimizing = false;
                console.error('Error checking overload:', error);
                // Fallback to normal optimization if check fails
                this.proceedWithOptimization();
            });
        },
        
        proceedWithOptimization() {
            this.isOptimizing = true;
            
            fetch('{% url "planner:reoptimize_week" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                this.isOptimizing = false;
                
                if (data.success) {
                    let message = data.message;
                    
                    // Add detailed feedback
                    if (data.utilization_rate) {
                        message += ` Utilization: ${data.utilization_rate}%`;
                    }
                    
                    this.showToast(message, 'success');
                    
                    // Show undo option if optimization was successful
                    if (data.can_undo && data.optimization_id) {
                        setTimeout(() => {
                            const undoToast = this.showUndoToast(data.optimization_id);
                        }, 1000);
                    }
                    
                    // Show recommendations if overloaded
                    if (data.recommendations && data.recommendations.length > 0) {
                        setTimeout(() => {
                            const recommendations = data.recommendations.join('\nâ€¢ ');
                            alert(`Recommendations:\nâ€¢ ${recommendations}`);
                        }, 1500);
                    }
                    
                    setTimeout(() => window.location.reload(), 3000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                this.isOptimizing = false;
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        showToast(message, type = 'info') {
            console.log(`SYNC DEBUG: Calendar showToast called with message: "${message}", type: ${type}`);
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        },
        
        showUndoToast(optimizationId) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            toast.className = 'bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300';
            toast.innerHTML = `
                <div class="flex items-center justify-between space-x-4">
                    <span>Optimization complete. Want to undo?</span>
                    <div class="flex space-x-2">
                        <button onclick="window.calendarApp.undoOptimization(${optimizationId})" class="bg-white text-yellow-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100">
                            Undo
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 30000);
            
            return toast;
        },
        
        undoOptimization(optimizationId) {
            fetch('{% url "planner:undo_optimization" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: `optimization_id=${optimizationId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Undo failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error during undo', 'error');
            });
        },
        
        formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        },
        
        createUrgentTask(title, estimatedHours, deadline) {
            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', 'Urgent task created via sacrifice mode');
            formData.append('estimated_hours', estimatedHours);
            formData.append('min_block_size', '0.5');
            formData.append('priority', '4');
            formData.append('deadline', deadline);
            formData.append('status', 'todo');
            
            fetch('{% url "planner:create_urgent_task" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.scheduled) {
                        this.showToast('Urgent task scheduled successfully!', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else if (data.sacrifice_mode) {
                        // Trigger sacrifice mode
                        this.urgentTask = {
                            id: data.task_id,
                            title: title,
                            estimated_hours: estimatedHours
                        };
                        this.conflictingTasks = data.conflicting_tasks;
                        this.selectedSacrifices = [];
                        this.targetDateTime = new Date().toISOString().slice(0, 16);
                        this.sacrificeMode = true;
                    }
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        cancelSacrificeMode() {
            this.sacrificeMode = false;
            this.urgentTask = null;
            this.conflictingTasks = [];
            this.selectedSacrifices = [];
            this.targetDateTime = null;
        },
        
        executeSacrifice() {
            if (!this.targetDateTime || !this.urgentTask) {
                this.showToast('Missing required information', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('urgent_task_id', this.urgentTask.id);
            formData.append('target_datetime', this.targetDateTime + ':00Z');
            
            // Add sacrifice task IDs
            this.selectedSacrifices.forEach(id => {
                formData.append('sacrifice_task_ids', id);
            });
            
            fetch('{% url "planner:sacrifice_tasks" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast(data.message, 'success');
                    this.cancelSacrificeMode();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        // AI Suggestions Functions
        getAISuggestions() {
            console.log('DEBUG: getAISuggestions() called');
            this.aiLoading = true;
            this.showAISuggestions = true;
            this.aiSuggestions = [];
            this.aiError = null;
            this.aiOverallScore = 0;
            this.aiReasoning = '';
            
            fetch('{% url "planner:get_ai_scheduling_suggestions" %}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                this.aiLoading = false;
                
                if (data.success) {
                    this.aiSuggestions = data.suggestions || [];
                    this.selectedSuggestions = [];
                    this.aiOverallScore = data.overall_score || 0.7;  // Default to 70% if not provided
                    this.aiReasoning = data.reasoning || 'AI analysis completed successfully.';
                    
                    if (this.aiSuggestions.length === 0) {
                        this.aiError = 'No AI suggestions available. Try adding more unscheduled tasks or time blocks.';
                    }
                } else {
                    this.aiError = data.error || 'Failed to get AI suggestions';
                }
            })
            .catch(error => {
                this.aiLoading = false;
                this.aiError = 'Network error while getting AI suggestions';
                console.error('AI Suggestions Error:', error);
            });
        },
        
        closeAISuggestions() {
            this.showAISuggestions = false;
            this.aiSuggestions = [];
            this.selectedSuggestions = [];
            this.aiError = null;
            this.aiLoading = false;
            this.aiOverallScore = 0;
            this.aiReasoning = '';
        },
        
        applyAISuggestions() {
            console.log('DEBUG: applyAISuggestions called with selectedSuggestions:', this.selectedSuggestions);
            
            if (this.selectedSuggestions.length === 0) {
                this.showToast('Please select at least one suggestion to apply', 'error');
                return;
            }
            
            const formData = new FormData();
            this.selectedSuggestions.forEach(suggestionId => {
                console.log('DEBUG: Adding suggestion ID to form:', suggestionId);
                formData.append('selected_suggestions', suggestionId);
            });
            
            console.log('DEBUG: Making request to apply AI suggestions...');
            fetch('{% url "planner:apply_ai_suggestions" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: formData
            })
            .then(response => {
                console.log('DEBUG: Apply AI suggestions response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('DEBUG: Apply AI suggestions data:', data);
                if (data.success) {
                    this.showToast(`Applied ${data.applied_count} AI suggestions successfully!`, 'success');
                    this.closeAISuggestions();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    this.showToast('Error applying AI suggestions: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('DEBUG: Error applying AI suggestions:', error);
                this.showToast('Network error while applying suggestions', 'error');
            });
        },
        
        // Overload Resolution Functions
        openOverloadModal(overloadData) {
            this.overloadInfo = overloadData;
            this.selectedResolution = '';
            this.showOverloadModal = true;
            this.isResolvingOverload = false;
        },
        
        closeOverloadModal() {
            this.showOverloadModal = false;
            this.overloadInfo = null;
            this.selectedResolution = '';
            this.isResolvingOverload = false;
        },
        
        executeOverloadResolution() {
            if (!this.selectedResolution || this.isResolvingOverload) return;
            
            this.isResolvingOverload = true;
            
            const endpoint = this.selectedResolution === 'compress' 
                ? '{% url "planner:compress_schedule" %}'
                : '{% url "planner:prioritize_schedule" %}';
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                this.isResolvingOverload = false;
                
                if (data.success) {
                    let message = this.selectedResolution === 'compress' 
                        ? `Schedule compressed! All tasks reduced to ${Math.round(data.compression_ratio * 100)}% of original duration.`
                        : `Priority scheduling complete! ${data.scheduled_count} tasks scheduled, ${data.unscheduled_count} tasks remain unscheduled.`;
                    
                    this.showToast(message, 'success');
                    this.closeOverloadModal();
                    
                    // Show additional info if available
                    if (data.details) {
                        setTimeout(() => {
                            alert(`Details:\n${data.details}`);
                        }, 1500);
                    }
                    
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                this.isResolvingOverload = false;
                console.error('Error:', error);
                this.showToast('Network error during resolution', 'error');
            });
        },
        
        // Current Time Indicator Functions
        shouldShowCurrentTimeIndicator() {
            // Only show if current time is within calendar hours (6 AM to 11 PM)
            const now = new Date();
            const currentHour = now.getHours();
            const withinCalendarHours = currentHour >= 6 && currentHour < 24;
            
            console.log(`Current hour: ${currentHour}, Within calendar hours: ${withinCalendarHours}`);
            return withinCalendarHours;
        },
        
        getCurrentTimePosition() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // Calculate position: each hour is 4rem tall, minutes are proportional
            // Adjust for calendar starting at 6 AM (offset by -6 hours)
            const adjustedHours = hours - 6; // Calendar starts at 6 AM
            const hourPosition = (adjustedHours * 4) + (minutes / 60 * 4);
            
            console.log(`Current time: ${hours}:${minutes.toString().padStart(2, '0')}, Position: ${hourPosition}rem`);
            return Math.max(0, hourPosition); // Don't show negative positions
        },
        
        getCurrentTimeLabel() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        },
        
        updateCurrentTimeIndicator() {
            // Force reactivity update by triggering a state change
            // Alpine.js will automatically re-evaluate reactive expressions
            console.log('Updating current time indicator...');
            
            // Force re-evaluation of time-dependent properties
            if (this.$refs && this.$refs.timeIndicator) {
                this.$refs.timeIndicator.style.top = this.getCurrentTimePosition() + 'rem';
            }
        },
        
        // Google Calendar Integration Functions
        isSyncing: false,
        
        quickSync() {
            console.log('DEBUG: quickSync() called');
            console.log('SYNC DEBUG: quickSync function called from calendar page');
            if (this.isSyncing) {
                console.log('SYNC DEBUG: quickSync ignored - already syncing');
                return;
            }
            
            this.isSyncing = true;
            
            fetch('{% url "planner:full_sync" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken(),
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => {
                console.log('SYNC DEBUG: quickSync response received');
                return response.json();
            })
            .then(data => {
                console.log('SYNC DEBUG: quickSync data processed');
                this.isSyncing = false;
                
                if (data.success) {
                    const total_events = (data.to_google?.events_created || 0) + 
                                       (data.to_google?.events_updated || 0) + 
                                       (data.from_google?.events_created || 0) + 
                                       (data.from_google?.events_updated || 0);
                    
                    this.showToast(`Google Calendar sync completed! ${total_events} events processed.`, 'success');
                    console.log('SYNC DEBUG: Calendar page showToast called for sync success');
                    
                    // Reload page after a short delay to show updated tasks
                    console.log('SYNC DEBUG: Calendar page will reload in 2 seconds');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    this.showToast('Google Calendar sync failed: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('SYNC DEBUG: quickSync error:', error);
                this.isSyncing = false;
                console.error('Error syncing with Google Calendar:', error);
                this.showToast('Network error during Google Calendar sync', 'error');
            });
        }
    }
}

// Make calendarApp globally accessible for undo functionality
document.addEventListener('alpine:init', () => {
    console.log('Alpine initialized - calendarApp function available:', typeof calendarApp);
    // Store a reference for the undo functionality after Alpine creates the component
    setTimeout(() => {
        const calendarElement = document.querySelector('[x-data*="calendarApp"]');
        if (calendarElement) {
            window.calendarApp = Alpine.$data(calendarElement);
        }
    }, 100);
});
</script>
{% endblock %}
